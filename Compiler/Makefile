CXX = clang++
CC = clang

CXXFLAGS := -std=c++2a
CFLAGS := -Iinclude -Wall -Wextra -Wpedantic -Wno-c99-extensions
LDFLAGS := 

ARGS ?= test_in.rw

FILES := src/main.cpp src/Error.cpp src/Files.cpp src/Config.cpp src/Timer.cpp src/Frontend/Scanner.cpp src/Frontend/Math.cpp src/Frontend/Parser.cpp src/Frontend/AstTreePrinter.cpp

.PHONY: test build clean release debug 

all: build

build: version_file
	mkdir -p build
	$(CXX) $(LDFLAGS) $(CXXFLAGS) $(CFLAGS) $(FILES) src/version.cpp -o build/rwc.out

release: CFLAGS += -O3
release: CXXFLAGS += -D NDEBUG -flto
release: build

dist: CXXFLAGS += -D NO_TIMERS
dist: release

debug: CFLAGS += -g -O0
debug: build

test: build
	build/rwc.out $(ARGS)

version_file:
	echo "/* Autogenerated seconds+nanoseconds since epoch for version hashing */ unsigned long long version_timecode = `date +%s%N`; const char *version_time = \"`date`\";" > src/version.cpp

celan: clean
clean:
	rm -rf src/*.o
	rm -rf src/*.d
	rm -rf src/Frontend/*.o
	rm -rf src/Frontend/*.d
	rm -rf srcpp/*.o
	rm -rf srcpp/*.d
	rm -rf build
